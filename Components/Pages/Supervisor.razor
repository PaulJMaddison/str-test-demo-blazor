@page "/supervisor"

<PageTitle>Supervisor Dashboard</PageTitle>

<h1>Supervisor Dashboard</h1>
<p class="text-muted">Monthly supervisory overview for testing throughput, quality, and cycle times.</p>

<section class="kpi-grid mb-4" aria-label="Supervisor KPI metrics">
    @foreach (var metric in KpiCards)
    {
        <article class="metric-card @metric.ThemeClass">
            <div class="metric-card__icon-wrap" aria-hidden="true">
                <img src="@metric.IconPath" alt="" class="metric-card__icon" />
            </div>
            <p class="metric-card__label">@metric.Label</p>
            <p class="metric-card__value">@metric.Value</p>
        </article>
    }
</section>

<section class="supervisor-chart-grid mb-4" aria-label="Regional and outcome charts">
    <article class="card str-card supervisor-panel" aria-labelledby="region-chart-title">
        <div class="card-body">
            <h2 class="h5" id="region-chart-title">Tests Completed per Region</h2>
            <ul class="bar-chart" aria-label="Completed tests by region">
                @foreach (var region in RegionData)
                {
                    <li class="bar-chart__row">
                        <span class="bar-chart__label">@region.Name</span>
                        <div class="bar-chart__track" role="img" aria-label="@region.Name completed tests: @region.Completed">
                            <span class="bar-chart__bar" style="width:@GetCompletedBarWidth(region.Completed)"></span>
                        </div>
                        <span class="bar-chart__value">@region.Completed</span>
                    </li>
                }
            </ul>
        </div>
    </article>

    <article class="card str-card supervisor-panel" aria-labelledby="pass-fail-chart-title">
        <div class="card-body">
            <h2 class="h5" id="pass-fail-chart-title">Overall Pass/Fail Rate</h2>
            <div class="donut-panel">
                <div class="donut-chart" role="img" aria-label="Pass @PassPercentage percent, Fail @FailPercentage percent, Not Applicable @NaPercentage percent"></div>
                <ul class="legend-list" aria-label="Pass fail legend">
                    <li><span class="legend-dot legend-dot--pass"></span>Pass (@PassPercentage%)</li>
                    <li><span class="legend-dot legend-dot--fail"></span>Fail (@FailPercentage%)</li>
                    <li><span class="legend-dot legend-dot--na"></span>N/A (@NaPercentage%)</li>
                </ul>
            </div>
        </div>
    </article>
</section>

<section class="card str-card supervisor-panel mb-4" aria-labelledby="type-chart-title">
    <div class="card-body">
        <h2 class="h5" id="type-chart-title">Average Time per Test Type</h2>

        <ul class="hbar-chart" aria-label="Average test minutes by test type">
            @foreach (var testType in TestTypeData)
            {
                <li class="hbar-chart__row">
                    <span class="hbar-chart__label">@testType.Name</span>
                    <div class="hbar-chart__track" role="img" aria-label="@testType.Name average time @testType.AverageMinutes minutes">
                        <span class="hbar-chart__bar" style="width:@GetAverageTimeWidth(testType.AverageMinutes)"></span>
                    </div>
                    <span class="hbar-chart__value">@testType.AverageMinutes min</span>
                </li>
            }
        </ul>
    </div>
</section>

@code {
    private static readonly IReadOnlyList<KpiMetric> KpiCards =
    [
        new("Tests This Month", "152", "metric-card--today", "demo-images/icon-clipboard.svg"),
        new("Overdue Tests", "18", "metric-card--overdue", "demo-images/icon-alert.svg"),
        new("Avg Completion Time", "64 min", "metric-card--completion", "demo-images/icon-timer.svg"),
        new("Unassigned Tests", "9", "metric-card--open", "demo-images/icon-dashboard.svg")
    ];

    private static readonly IReadOnlyList<RegionMetric> RegionData =
    [
        new("North", 36),
        new("South", 28),
        new("East", 33),
        new("West", 24),
        new("Central", 31)
    ];

    private static readonly IReadOnlyList<TestTypeMetric> TestTypeData =
    [
        new("Electrical Safety", 72),
        new("Functional", 58),
        new("Calibration", 66),
        new("Visual Inspection", 41),
        new("Leak Test", 53)
    ];

    private static int PassPercentage => 82;
    private static int FailPercentage => 12;
    private static int NaPercentage => 6;

    private static string GetCompletedBarWidth(int value)
    {
        var max = RegionData.Max(region => region.Completed);
        return $"{Math.Round((double)value / max * 100, 0)}%";
    }

    private static string GetAverageTimeWidth(int minutes)
    {
        var max = TestTypeData.Max(testType => testType.AverageMinutes);
        return $"{Math.Round((double)minutes / max * 100, 0)}%";
    }

    private sealed record KpiMetric(string Label, string Value, string ThemeClass, string IconPath);
    private sealed record RegionMetric(string Name, int Completed);
    private sealed record TestTypeMetric(string Name, int AverageMinutes);
}

@page "/supervisor"
@using str_test_demo_blazor.Components.Charts

<PageTitle>Supervisor Dashboard</PageTitle>

<h1>Supervisor Dashboard</h1>
<p class="text-muted">Monthly supervisory overview for testing throughput, quality, and cycle times.</p>

<section class="kpi-grid mb-4" aria-label="Supervisor KPI metrics">
    @foreach (var metric in CurrentKpiCards)
    {
        <article class="metric-card @metric.ThemeClass">
            <div class="metric-card__icon-wrap" aria-hidden="true">
                <img src="@metric.IconPath" alt="" class="metric-card__icon" />
            </div>
            <p class="metric-card__label">@metric.Label</p>
            <p class="metric-card__value">@metric.Value</p>
        </article>
    }
</section>


<section class="card str-card mb-4" aria-label="Supervisor filters">
    <div class="card-body supervisor-filters">
        <div>
            <label class="form-label" for="time-window">Time Window</label>
            <select id="time-window" class="form-select" @bind="SelectedWindow">
                <option>7 days</option>
                <option>30 days</option>
                <option>90 days</option>
            </select>
        </div>
        <div>
            <label class="form-label" for="supervisor-region">Region</label>
            <select id="supervisor-region" class="form-select" @bind="SelectedRegion">
                <option>All Regions</option>
                <option>North</option>
                <option>South</option>
                <option>East</option>
                <option>West</option>
                <option>Central</option>
            </select>
        </div>
        <div>
            <label class="form-label" for="owner-filter">Owner</label>
            <select id="owner-filter" class="form-select" @bind="SelectedOwner">
                <option>All Owners</option>
                <option>Field Team A</option>
                <option>Field Team B</option>
                <option>Contractor</option>
            </select>
        </div>
    </div>
</section>

<section class="supervisor-chart-grid mb-4" aria-label="Regional and outcome charts">
    <article class="card str-card supervisor-panel" aria-labelledby="region-chart-title">
        <div class="card-body">
            <h2 class="h5" id="region-chart-title">Tests Completed per Region</h2>
            <div class="str-card" style="height:300px">
                <ChartJsWrapper ChartId="supervisor-region-chart" ChartType="bar" Labels="@RegionLabels" Data="@RegionValues" BackgroundColors="@RegionColors" />
            </div>
        </div>
    </article>

    <article class="card str-card supervisor-panel" aria-labelledby="pass-fail-chart-title">
        <div class="card-body">
            <h2 class="h5" id="pass-fail-chart-title">Overall Pass/Fail Rate</h2>
            <div class="str-card" style="height:300px">
                <ChartJsWrapper ChartId="supervisor-outcome-chart" ChartType="doughnut" Labels="@OutcomeLabels" Data="@OutcomeValues" BackgroundColors="@OutcomeColors" />
            </div>
        </div>
    </article>
</section>

<section class="card str-card supervisor-panel mb-4" aria-labelledby="type-chart-title">
    <div class="card-body">
        <h2 class="h5" id="type-chart-title">Average Time per Test Type</h2>
        <div class="str-card" style="height:300px">
            <ChartJsWrapper ChartId="supervisor-type-chart" ChartType="bar" Labels="@TestTypeLabels" Data="@TestTypeValues" BackgroundColors="@TestTypeColors" />
        </div>
    </div>
</section>

@code {
    private string SelectedWindow { get; set; } = "30 days";
    private string SelectedRegion { get; set; } = "All Regions";
    private string SelectedOwner { get; set; } = "All Owners";

    private static readonly string[] OutcomeLabels = ["Pass", "Fail", "N/A"];
    private static readonly string[] OutcomeColors = ["#4CAF50", "#E57373", "#90A4AE"];
    private static readonly string[] TestTypeLabels = ["Electrical Safety", "Functional", "Calibration", "Visual Inspection", "Leak Test"];
    private static readonly string[] TestTypeColors = ["#1E3A8A", "#2563EB", "#3B82F6", "#60A5FA", "#93C5FD"];
    private static readonly string[] RegionPalette = ["#1E40AF", "#2563EB", "#3B82F6", "#60A5FA", "#93C5FD"];

    private static readonly IReadOnlyList<RegionOwnerSnapshot> SnapshotData =
    [
        new("North", "Field Team A", 52, 45, 5, 2, 68, 56, 62, 42, 50),
        new("North", "Field Team B", 47, 39, 6, 2, 70, 60, 65, 44, 53),
        new("North", "Contractor", 30, 24, 4, 2, 75, 63, 69, 46, 57),

        new("South", "Field Team A", 44, 37, 5, 2, 69, 57, 61, 43, 51),
        new("South", "Field Team B", 41, 33, 6, 2, 72, 61, 66, 46, 55),
        new("South", "Contractor", 27, 21, 4, 2, 76, 64, 70, 49, 58),

        new("East", "Field Team A", 49, 42, 5, 2, 67, 55, 60, 41, 49),
        new("East", "Field Team B", 45, 37, 6, 2, 71, 59, 64, 45, 54),
        new("East", "Contractor", 29, 23, 4, 2, 74, 62, 68, 47, 56),

        new("West", "Field Team A", 39, 32, 5, 2, 70, 58, 63, 44, 52),
        new("West", "Field Team B", 36, 29, 5, 2, 73, 62, 67, 47, 55),
        new("West", "Contractor", 23, 18, 3, 2, 77, 65, 71, 50, 59),

        new("Central", "Field Team A", 46, 39, 5, 2, 66, 54, 59, 40, 48),
        new("Central", "Field Team B", 42, 35, 5, 2, 69, 58, 63, 43, 52),
        new("Central", "Contractor", 28, 22, 4, 2, 73, 61, 67, 46, 55)
    ];

    private IEnumerable<RegionOwnerSnapshot> FilteredSnapshots => SnapshotData.Where(MatchesFilters);

    private IReadOnlyList<KpiMetric> CurrentKpiCards
    {
        get
        {
            var snapshots = FilteredSnapshots.ToList();
            var completed = ScaleCount(snapshots.Sum(snapshot => snapshot.Completed));
            var fail = ScaleCount(snapshots.Sum(snapshot => snapshot.Fail));
            var notApplicable = ScaleCount(snapshots.Sum(snapshot => snapshot.NotApplicable));
            var avgMinutes = (int)Math.Round(ComputeWeightedAverageMinutes(snapshots));
            var overdue = (int)Math.Round((fail + notApplicable) * 0.58, MidpointRounding.AwayFromZero);
            var unassigned = Math.Max(2, (int)Math.Round(completed * 0.05, MidpointRounding.AwayFromZero));

            return
            [
                new("Tests in Window", completed.ToString(), "metric-card--today", "demo-images/icon-clipboard.svg"),
                new("Overdue Tests", overdue.ToString(), "metric-card--overdue", "demo-images/icon-alert.svg"),
                new("Avg Completion Time", $"{avgMinutes} min", "metric-card--completion", "demo-images/icon-timer.svg"),
                new("Unassigned Tests", unassigned.ToString(), "metric-card--open", "demo-images/icon-dashboard.svg")
            ];
        }
    }

    private string[] RegionLabels => FilteredSnapshots
        .GroupBy(snapshot => snapshot.Region)
        .OrderBy(group => group.Key)
        .Select(group => group.Key)
        .ToArray();

    private double[] RegionValues => FilteredSnapshots
        .GroupBy(snapshot => snapshot.Region)
        .OrderBy(group => group.Key)
        .Select(group => (double)ScaleCount(group.Sum(snapshot => snapshot.Completed)))
        .ToArray();

    private string[] RegionColors => RegionLabels
        .Select((label, i) => RegionPalette[i % RegionPalette.Length])
        .ToArray();

    private double[] OutcomeValues
    {
        get
        {
            var snapshots = FilteredSnapshots.ToList();
            return
            [
                ScaleCount(snapshots.Sum(snapshot => snapshot.Pass)),
                ScaleCount(snapshots.Sum(snapshot => snapshot.Fail)),
                ScaleCount(snapshots.Sum(snapshot => snapshot.NotApplicable))
            ];
        }
    }

    private double[] TestTypeValues
    {
        get
        {
            var snapshots = FilteredSnapshots.ToList();
            var durationAdjustment = SelectedWindow switch
            {
                "7 days" => 2,
                "90 days" => -2,
                _ => 0
            };

            if (snapshots.Count == 0)
            {
                return [0, 0, 0, 0, 0];
            }

            return
            [
                Math.Round(snapshots.Average(snapshot => snapshot.ElectricalSafetyMinutes) + durationAdjustment, 1),
                Math.Round(snapshots.Average(snapshot => snapshot.FunctionalMinutes) + durationAdjustment, 1),
                Math.Round(snapshots.Average(snapshot => snapshot.CalibrationMinutes) + durationAdjustment, 1),
                Math.Round(snapshots.Average(snapshot => snapshot.VisualInspectionMinutes) + durationAdjustment, 1),
                Math.Round(snapshots.Average(snapshot => snapshot.LeakTestMinutes) + durationAdjustment, 1)
            ];
        }
    }

    private bool MatchesFilters(RegionOwnerSnapshot snapshot)
    {
        var regionMatch = SelectedRegion == "All Regions" || snapshot.Region == SelectedRegion;
        var ownerMatch = SelectedOwner == "All Owners" || snapshot.Owner == SelectedOwner;
        return regionMatch && ownerMatch;
    }

    private int ScaleCount(int value)
    {
        var multiplier = SelectedWindow switch
        {
            "7 days" => 0.23,
            "90 days" => 2.9,
            _ => 1.0
        };

        return (int)Math.Max(1, Math.Round(value * multiplier, MidpointRounding.AwayFromZero));
    }

    private double ComputeWeightedAverageMinutes(IReadOnlyList<RegionOwnerSnapshot> snapshots)
    {
        if (snapshots.Count == 0)
        {
            return 0;
        }

        var totalCompleted = snapshots.Sum(snapshot => snapshot.Completed);
        if (totalCompleted == 0)
        {
            return 0;
        }

        var weightedSum = snapshots.Sum(snapshot => snapshot.Completed *
            (snapshot.ElectricalSafetyMinutes + snapshot.FunctionalMinutes + snapshot.CalibrationMinutes + snapshot.VisualInspectionMinutes + snapshot.LeakTestMinutes) / 5.0);

        var adjustment = SelectedWindow switch
        {
            "7 days" => 2,
            "90 days" => -2,
            _ => 0
        };

        return (weightedSum / totalCompleted) + adjustment;
    }

    private sealed record KpiMetric(string Label, string Value, string ThemeClass, string IconPath);

    private sealed record RegionOwnerSnapshot(
        string Region,
        string Owner,
        int Completed,
        int Pass,
        int Fail,
        int NotApplicable,
        int ElectricalSafetyMinutes,
        int FunctionalMinutes,
        int CalibrationMinutes,
        int VisualInspectionMinutes,
        int LeakTestMinutes);
}

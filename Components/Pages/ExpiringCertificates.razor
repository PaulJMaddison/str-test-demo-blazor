@page "/expiring-certificates"
@rendermode InteractiveServer

<PageTitle>Upcoming Expiring Certificates</PageTitle>

<section class="expiry-page-header mb-4">
    <h1 class="mb-2">Upcoming Expiring Certificates</h1>
    <p class="text-muted mb-0">Monitor expiring certificates and prioritize renewals by urgency.</p>
</section>

@if (!string.IsNullOrWhiteSpace(NotificationMessage))
{
    <div class="alert alert-success alert-dismissible fade show" role="status" aria-live="polite">
        @NotificationMessage
        <button type="button" class="btn-close" aria-label="Close" @onclick="DismissNotification"></button>
    </div>
}

<section class="expiry-kpi-grid" aria-label="Expiry certificate KPI metrics">
    @foreach (var card in KpiCards)
    {
        <article class="expiry-kpi @card.CardClass">
            <p class="expiry-kpi__label">@card.Label</p>
            <p class="expiry-kpi__value">@card.Count</p>
        </article>
    }
</section>

<section class="card str-card expiry-filter-card mb-4" aria-label="Expiry filters">
    <div class="card-body expiry-filters">
        <div class="filter-item">
            <label class="form-label" for="region-filter">Region</label>
            <select id="region-filter" class="form-select" @bind="SelectedRegion">
                @foreach (var region in RegionOptions)
                {
                    <option value="@region">@region</option>
                }
            </select>
        </div>

        <div class="filter-item">
            <label class="form-label" for="window-filter">Expiring within</label>
            <select id="window-filter" class="form-select" @bind="SelectedWindowDays">
                @foreach (var option in ExpiryWindowOptions)
                {
                    <option value="@option">@option days</option>
                }
            </select>
        </div>

        <div class="filter-item filter-item--search">
            <label class="form-label" for="search-filter">Search</label>
            <input id="search-filter"
                   class="form-control"
                   type="search"
                   placeholder="Asset number, test type, asset type"
                   @bind="SearchQuery"
                   @bind:event="oninput" />
        </div>

        <div class="filter-item filter-item--actions">
            <button type="button" class="btn btn-outline-secondary" @onclick="ResetFilters">Reset</button>
        </div>
    </div>
</section>

<section class="card str-card expiry-table-card" aria-labelledby="expiring-certificates-table-title">
    <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h2 class="h5 mb-0" id="expiring-certificates-table-title">Certificates requiring attention</h2>
            <small class="text-muted">@FilteredCertificates.Count result(s)</small>
        </div>

        @if (FilteredCertificates.Count == 0)
        {
            <div class="expiry-empty-state" role="status">
                <h3 class="h6 mb-2">No certificates match your filters.</h3>
                <p class="text-muted mb-3">Try broadening your region, window, or search criteria.</p>
                <button type="button" class="btn btn-outline-secondary" @onclick="ResetFilters">Reset filters</button>
            </div>
        }
        else
        {
            <div class="table-responsive expiry-table-wrap">
                <table class="table align-middle mb-0 expiry-table">
                    <thead>
                        <tr>
                            <th>Urgency</th>
                            <th>Asset Number</th>
                            <th>Test Type</th>
                            <th>Asset Type</th>
                            <th>Region</th>
                            <th>Expiry Date</th>
                            <th>Days Remaining</th>
                            <th>Status</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var cert in FilteredCertificates)
                        {
                            var urgency = GetUrgency(cert);
                            <tr>
                                <td>
                                    <div class="urgency-cell">
                                        <span class="urgency-dot @GetUrgencyDotClass(urgency)" aria-hidden="true"></span>
                                        <span>@urgency</span>
                                    </div>
                                </td>
                                <td class="fw-semibold">@cert.AssetNumber</td>
                                <td>@cert.TestType</td>
                                <td>@cert.AssetType</td>
                                <td>@cert.Region</td>
                                <td>@cert.ExpiryDate.ToString("yyyy-MM-dd")</td>
                                <td>@FormatDaysRemaining(cert)</td>
                                <td>
                                    <span class="status-pill @GetStatusPillClass(urgency)">@GetStatusLabel(urgency)</span>
                                </td>
                                <td class="text-end">
                                    <button type="button"
                                            class="btn btn-outline-primary btn-sm"
                                            @onclick="() => CreateRenewal(cert)">
                                        Create Renewal
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }

        <p class="text-muted small mb-0 mt-3">Demo data shown from in-memory records.</p>
    </div>
</section>

@code {
    private const string AllRegionsLabel = "All Regions";

    private readonly List<int> ExpiryWindowOptions = new() { 7, 14, 30, 60 };

    private readonly List<CertificateExpiry> Certificates = new()
    {
        new("A-10021", "Annual Safety", "Boiler", "North", DateTime.Today.AddDays(-2)),
        new("A-10043", "Pressure Check", "Compressor", "South", DateTime.Today.AddDays(1)),
        new("A-10087", "Electrical", "Generator", "East", DateTime.Today.AddDays(3)),
        new("A-10112", "Calibration", "Lift", "West", DateTime.Today.AddDays(5)),
        new("A-10144", "Hydraulic", "Crane", "North", DateTime.Today.AddDays(8)),
        new("A-10155", "Load Test", "Hoist", "South", DateTime.Today.AddDays(12)),
        new("A-10198", "Inspection", "Forklift", "Central", DateTime.Today.AddDays(20)),
        new("A-10204", "Compliance", "Pump", "East", DateTime.Today.AddDays(27)),
        new("A-10250", "Acoustic", "Compressor", "North", DateTime.Today.AddDays(-6)),
        new("A-10271", "Thermal", "Boiler", "West", DateTime.Today.AddDays(2)),
        new("A-10288", "Vibration", "Fan", "Central", DateTime.Today.AddDays(7)),
        new("A-10305", "Leak Test", "Pipework", "North", DateTime.Today.AddDays(14)),
        new("A-10322", "Emission", "Generator", "South", DateTime.Today.AddDays(34))
    };

    private string SelectedRegion { get; set; } = AllRegionsLabel;
    private int SelectedWindowDays { get; set; } = 30;
    private string SearchQuery { get; set; } = string.Empty;
    private string NotificationMessage { get; set; } = string.Empty;

    private List<string> RegionOptions => new[] { AllRegionsLabel }
        .Concat(Certificates.Select(c => c.Region).Distinct(StringComparer.OrdinalIgnoreCase).OrderBy(r => r))
        .ToList();

    private List<CertificateExpiry> FilteredCertificates => Certificates
        .Where(c => SelectedRegion == AllRegionsLabel || c.Region == SelectedRegion)
        .Where(c => GetDaysRemaining(c) <= SelectedWindowDays)
        .Where(ApplySearchFilter)
        .OrderBy(c => c.ExpiryDate)
        .ToList();

    private IReadOnlyList<KpiCard> KpiCards =>
    [
        new("EXPIRED", FilteredCertificates.Count(c => GetDaysRemaining(c) < 0), "expiry-kpi--expired"),
        new("CRITICAL (<=3 DAYS)", FilteredCertificates.Count(c => GetDaysRemaining(c) >= 0 && GetDaysRemaining(c) <= 3), "expiry-kpi--critical"),
        new("URGENT (<=7 DAYS)", FilteredCertificates.Count(c => GetDaysRemaining(c) > 3 && GetDaysRemaining(c) <= 7), "expiry-kpi--urgent"),
        new("WARNING (<=14 DAYS)", FilteredCertificates.Count(c => GetDaysRemaining(c) > 7 && GetDaysRemaining(c) <= 14), "expiry-kpi--warning")
    ];

    private void ResetFilters()
    {
        SelectedRegion = AllRegionsLabel;
        SelectedWindowDays = 30;
        SearchQuery = string.Empty;
    }

    private void CreateRenewal(CertificateExpiry certificate)
    {
        NotificationMessage = $"Demo: renewal created for {certificate.AssetNumber}.";
    }

    private void DismissNotification()
    {
        NotificationMessage = string.Empty;
    }

    private bool ApplySearchFilter(CertificateExpiry certificate)
    {
        if (string.IsNullOrWhiteSpace(SearchQuery))
        {
            return true;
        }

        return certificate.AssetNumber.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase)
            || certificate.TestType.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase)
            || certificate.AssetType.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase);
    }

    private static int GetDaysRemaining(CertificateExpiry certificate)
    {
        return (certificate.ExpiryDate.Date - DateTime.Today).Days;
    }

    private static string FormatDaysRemaining(CertificateExpiry certificate)
    {
        var daysRemaining = GetDaysRemaining(certificate);

        if (daysRemaining < 0)
        {
            return $"Overdue by {Math.Abs(daysRemaining)} day{GetPluralSuffix(daysRemaining)}";
        }

        if (daysRemaining == 0)
        {
            return "Due today";
        }

        return $"In {daysRemaining} day{GetPluralSuffix(daysRemaining)}";
    }

    private static string GetPluralSuffix(int dayValue)
    {
        return Math.Abs(dayValue) == 1 ? string.Empty : "s";
    }

    private static string GetUrgency(CertificateExpiry certificate)
    {
        var daysRemaining = GetDaysRemaining(certificate);

        if (daysRemaining < 0)
        {
            return "Expired";
        }

        if (daysRemaining <= 3)
        {
            return "Critical";
        }

        if (daysRemaining <= 7)
        {
            return "Urgent";
        }

        if (daysRemaining <= 14)
        {
            return "Warning";
        }

        return "Valid";
    }

    private static string GetStatusLabel(string urgency)
    {
        return urgency.ToUpperInvariant();
    }

    private static string GetStatusPillClass(string urgency)
    {
        return urgency switch
        {
            "Expired" => "expiry-status-pill--expired",
            "Critical" => "expiry-status-pill--critical",
            "Urgent" => "expiry-status-pill--urgent",
            "Warning" => "expiry-status-pill--warning",
            _ => "expiry-status-pill--valid"
        };
    }

    private static string GetUrgencyDotClass(string urgency)
    {
        return urgency switch
        {
            "Expired" => "urgency-dot--expired",
            "Critical" => "urgency-dot--critical",
            "Urgent" => "urgency-dot--urgent",
            "Warning" => "urgency-dot--warning",
            _ => "urgency-dot--valid"
        };
    }

    private sealed record CertificateExpiry(
        string AssetNumber,
        string TestType,
        string AssetType,
        string Region,
        DateTime ExpiryDate);

    private sealed record KpiCard(string Label, int Count, string CardClass);
}

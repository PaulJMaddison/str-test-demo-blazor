@page "/certificate/{TestId:guid}"
@inject IJSRuntime Js
@inject str_test_demo_blazor.Services.DemoDataService DemoData

<PageTitle>Certificate</PageTitle>

@if (_testRun is null || _asset is null || _template is null)
{
    <h1>Certificate</h1>
    <p class="text-muted">No completed test run found for this certificate.</p>
}
else
{
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3 no-print">
        <h1 class="mb-0">Certificate Preview</h1>
        <button class="btn btn-primary" type="button" @onclick="Print">Print</button>
    </div>

    <article class="certificate card str-card">
        <div class="card-body p-4 p-md-5">
            <div class="result-banner @(FailCount > 0 ? "result-banner-fail" : "result-banner-pass") mb-4" role="status">
                @if (FailCount > 0)
                {
                    <strong>FAILED</strong>
                    <span>@FailCount issue@(FailCount == 1 ? string.Empty : "s") found</span>
                }
                else
                {
                    <strong>PASSED</strong>
                    <span>No failed checks detected</span>
                }
            </div>

            <header class="certificate-header mb-4 pb-3 border-bottom">
                <p class="text-uppercase text-muted small mb-2">Serviceability Test Certificate</p>
                <h2 class="h3 mb-1">Serviceability Test Certificate</h2>
                <p class="mb-0 text-muted">Certificate ID: @_testRun.Id</p>
            </header>

            <section class="row g-3 mb-4">
                <div class="col-12 col-md-6">
                    <h3 class="h6 text-uppercase text-muted">Asset</h3>
                    <p class="mb-1"><strong>Tag:</strong> @_asset.AssetTag</p>
                    <p class="mb-1"><strong>Serial:</strong> @_asset.Serial</p>
                    <p class="mb-1"><strong>Type:</strong> @_asset.Type</p>
                    <p class="mb-0"><strong>Location:</strong> @_asset.Location</p>
                </div>
                <div class="col-12 col-md-6">
                    <h3 class="h6 text-uppercase text-muted">Test Run</h3>
                    <p class="mb-1"><strong>Template:</strong> @_template.Name</p>
                    <div class="certificate-meta-grid">
                        <p class="mb-1"><span class="text-muted">Completed by</span><span>@_testRun.TechnicianName</span></p>
                        <p class="mb-0"><span class="text-muted">Completed at</span><span>@_testRun.CompletedAt?.ToString("f")</span></p>
                    </div>
                </div>
            </section>

            <section class="mb-4">
                <h3 class="h6 text-uppercase text-muted">Summary</h3>
                <div class="row g-3 summary-grid" aria-label="Certificate summary metrics">
                    <div class="col-6 col-md-3">
                        <div class="summary-card summary-card-pass">
                            <p class="summary-card-label mb-2">Pass Count</p>
                            <p class="summary-card-value mb-0">@PassCount</p>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="summary-card summary-card-fail">
                            <p class="summary-card-label mb-2">Fail Count</p>
                            <p class="summary-card-value mb-0">@FailCount</p>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="summary-card summary-card-neutral">
                            <p class="summary-card-label mb-2">N/A Count</p>
                            <p class="summary-card-value mb-0">@NaCount</p>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="summary-card summary-card-time">
                            <p class="summary-card-label mb-2">Total Minutes</p>
                            <p class="summary-card-value mb-0">@(_testRun.TotalMinutes)</p>
                        </div>
                    </div>
                </div>
            </section>

            <section class="mb-4">
                <h3 class="h6 text-uppercase text-muted">Task Results</h3>
                <div class="table-responsive">
                    <table class="table table-bordered align-middle mb-0 certificate-table">
                        <thead class="table-light">
                            <tr>
                                <th>Task</th>
                                <th>Result</th>
                                <th>Comment</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var task in _testRun.TestTaskRuns)
                            {
                                <tr class="task-row">
                                    <td>@task.Title</td>
                                    <td><span class="result-pill @GetResultClass(task.Result)">@task.Result</span></td>
                                    <td>
                                        @if (string.IsNullOrWhiteSpace(task.Comment))
                                        {
                                            <span class="text-muted">â€”</span>
                                        }
                                        else
                                        {
                                            @task.Comment
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </section>

            <section>
                <h3 class="h6 text-uppercase text-muted">Photo Thumbnails</h3>
                @if (AssetPhotoGalleryPaths.Count == 0)
                {
                    <p class="text-muted mb-0">No photos attached.</p>
                }
                else
                {
                    <div class="certificate-photo-grid">
                        @foreach (var path in AssetPhotoGalleryPaths)
                        {
                            <button class="certificate-photo-button" type="button" @onclick="() => OpenPhoto(path)">
                                <img class="certificate-photo" src="@ToWebPath(path)" alt="Asset evidence photo" />
                            </button>
                        }
                    </div>
                }
            </section>

            <footer class="print-footer">Generated by STR Serviceability Testing (Demo)</footer>
        </div>
    </article>

    @if (_activePhotoPath is not null)
    {
        <div class="certificate-photo-modal" role="dialog" aria-modal="true" @onclick="ClosePhoto">
            <div class="certificate-photo-modal-card" @onclick:stopPropagation="true">
                <button class="btn btn-sm btn-outline-light certificate-photo-modal-close" type="button" @onclick="ClosePhoto">Close</button>
                <img class="certificate-photo-preview" src="@ToWebPath(_activePhotoPath)" alt="Expanded asset photo" />
            </div>
        </div>
    }
}

@code {
    [Parameter]
    public Guid TestId { get; set; }

    private str_test_demo_blazor.Domain.TestRun? _testRun;
    private str_test_demo_blazor.Domain.Asset? _asset;
    private str_test_demo_blazor.Domain.TestTemplate? _template;
    private string? _activePhotoPath;

    private int PassCount => _testRun?.TestTaskRuns.Count(task => task.Result == str_test_demo_blazor.Domain.TestTaskResult.Pass) ?? 0;
    private int FailCount => _testRun?.TestTaskRuns.Count(task => task.Result == str_test_demo_blazor.Domain.TestTaskResult.Fail) ?? 0;
    private int NaCount => _testRun?.TestTaskRuns.Count(task => task.Result == str_test_demo_blazor.Domain.TestTaskResult.NA) ?? 0;

    private IReadOnlyList<string> AssetPhotoGalleryPaths =>
        _testRun?.TestTaskRuns
            .SelectMany(task => task.PhotoSvgPaths)
            .Where(path => AssetPhotoCandidates.Contains(path))
            .Distinct()
            .ToList() ?? [];

    private static readonly IReadOnlyList<string> AssetPhotoCandidates =
    [
        "demo-images/asset-photos/asset-hydraulic-press.svg",
        "demo-images/asset-photos/asset-crane-assembly.svg",
        "demo-images/asset-photos/asset-compressor-unit.svg",
        "demo-images/asset-photos/asset-power-panel.svg"
    ];

    protected override void OnParametersSet()
    {
        _testRun = DemoData.FindTestRun(TestId);

        if (_testRun is null || _testRun.Status != str_test_demo_blazor.Domain.TestRunStatus.Completed)
        {
            _testRun = null;
            _asset = null;
            _template = null;
            return;
        }

        _asset = DemoData.FindAsset(_testRun.AssetId);
        _template = DemoData.FindTemplate(_testRun.TemplateId);
    }

    private async Task Print() => await Js.InvokeVoidAsync("print");

    private static string GetResultClass(str_test_demo_blazor.Domain.TestTaskResult result)
    {
        return result switch
        {
            str_test_demo_blazor.Domain.TestTaskResult.Pass => "result-pill-pass",
            str_test_demo_blazor.Domain.TestTaskResult.Fail => "result-pill-fail",
            _ => "result-pill-neutral"
        };
    }

    private void OpenPhoto(string path) => _activePhotoPath = path;

    private void ClosePhoto() => _activePhotoPath = null;

    private static string ToWebPath(string path) => path.StartsWith('/') ? path : $"/{path}";
}

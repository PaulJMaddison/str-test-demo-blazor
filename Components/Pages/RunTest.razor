@page "/run-test"
@page "/run-test/{TestId:guid}"
@inject NavigationManager Navigation
@inject str_test_demo_blazor.Services.DemoDataService DemoData

<PageTitle>Run Test</PageTitle>

<h1>Run Test</h1>
<p class="text-muted">Demo-only test execution workflow with in-memory service data.</p>

<section class="card shadow-sm mb-4">
    <div class="card-body">
        <h2 class="h5">Start Test</h2>
        <div class="row g-3">
            <div class="col-12 col-md-6">
                <label class="form-label" for="asset-select">Asset</label>
                <select id="asset-select" class="form-select" @bind="SelectedAssetId">
                    @foreach (var asset in DemoData.Assets)
                    {
                        <option value="@asset.Id">@asset.AssetTag (@asset.Location)</option>
                    }
                </select>
            </div>
            <div class="col-12 col-md-6">
                <label class="form-label" for="template-select">Template</label>
                <select id="template-select" class="form-select" @bind="SelectedTemplateId">
                    @foreach (var template in DemoData.Templates)
                    {
                        <option value="@template.Id">@template.Name</option>
                    }
                </select>
            </div>
            <div class="col-12">
                <button class="btn btn-primary btn-lg" @onclick="StartTest">Start</button>
            </div>
        </div>
    </div>
</section>

@if (CurrentRun is not null)
{
    var asset = DemoData.FindAsset(CurrentRun.AssetId);
    var template = DemoData.FindTemplate(CurrentRun.TemplateId);

    <section class="card shadow-sm">
        <div class="card-body">
            <h2 class="h5">Demo Test Session</h2>
            <p class="mb-1"><strong>Test ID:</strong> @CurrentRun.Id</p>
            <p class="mb-1"><strong>Asset:</strong> @asset?.AssetTag</p>
            <p class="mb-1"><strong>Template:</strong> @template?.Name</p>
            <p class="mb-1"><strong>Status:</strong> @CurrentRun.Status</p>
            <p class="mb-0"><strong>Task Count:</strong> @CurrentRun.TestTaskRuns.Count</p>
        </div>
    </section>
}

@code {
    [Parameter]
    public Guid? TestId { get; set; }

    private Guid SelectedAssetId { get; set; }
    private Guid SelectedTemplateId { get; set; }

    private str_test_demo_blazor.Domain.TestRun? CurrentRun =>
        TestId is Guid id ? DemoData.TestRuns.FirstOrDefault(run => run.Id == id) : null;

    protected override void OnInitialized()
    {
        SelectedAssetId = DemoData.Assets.First().Id;
        SelectedTemplateId = DemoData.Templates.First().Id;
    }

    private void StartTest()
    {
        var run = DemoData.CreateTestRun(SelectedAssetId, SelectedTemplateId);
        Navigation.NavigateTo($"/run-test/{run.Id}");
    }
}

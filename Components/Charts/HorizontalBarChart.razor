@using System.Globalization

<div class="hbar-chart" role="img" aria-label="Horizontal bar chart showing tests by technician with axis values">
    <div class="hbar-chart__rows" aria-hidden="true">
        @foreach (var row in Rows)
        {
            <div class="hbar-chart__row">
                <div class="hbar-chart__label">@row.Label</div>
                <div class="hbar-chart__plot">
                    <div class="hbar-chart__track"></div>
                    <div class="hbar-chart__fill" style="width:@row.WidthPercent.ToString("0.##", CultureInfo.InvariantCulture)%"></div>
                    <span class="hbar-chart__value">@row.ValueLabel</span>
                </div>
            </div>
        }
    </div>

    <div class="hbar-chart__axis" aria-hidden="true">
        @foreach (var tick in AxisTicks)
        {
            <span class="hbar-chart__tick" style="left:@tick.LeftPercent.ToString("0.##", CultureInfo.InvariantCulture)%">@tick.Label</span>
        }
        <span class="hbar-chart__axis-title">Tests (count)</span>
    </div>
</div>

@code {
    [Parameter, EditorRequired] public string[] Labels { get; set; } = Array.Empty<string>();
    [Parameter, EditorRequired] public double[] Values { get; set; } = Array.Empty<double>();

    private double MaxValue => Math.Max(1, Values.Take(Math.Min(Labels.Length, Values.Length)).DefaultIfEmpty(1).Max());

    private IReadOnlyList<ChartRow> Rows
    {
        get
        {
            var count = Math.Min(Labels.Length, Values.Length);
            if (count == 0)
            {
                return Array.Empty<ChartRow>();
            }

            var max = MaxValue;
            return Enumerable.Range(0, count)
                .Select(index =>
                {
                    var value = Math.Max(0, Values[index]);
                    var width = value / max * 100;
                    return new ChartRow(
                        Labels[index],
                        width,
                        value.ToString("0.#", CultureInfo.InvariantCulture));
                })
                .ToArray();
        }
    }

    private IReadOnlyList<AxisTick> AxisTicks
    {
        get
        {
            var max = MaxValue;
            const int steps = 4;
            return Enumerable.Range(0, steps + 1)
                .Select(index =>
                {
                    var ratio = index / (double)steps;
                    var value = max * ratio;
                    return new AxisTick(ratio * 100, value.ToString("0.#", CultureInfo.InvariantCulture));
                })
                .ToArray();
        }
    }

    private sealed record ChartRow(string Label, double WidthPercent, string ValueLabel);
    private sealed record AxisTick(double LeftPercent, string Label);
}
